import{h as d,d as e,m as v,z as S,t as g,E as T,q as m,F as P,l as j,r as y,B as L,A as V,g as a,u as G,x as K,o as Q,b as U,w as A,k,e as z,v as E,c as q,D as J,f as W,j as X}from"./index-oBUesopq.js";import{_ as N,a as Y,c as Z}from"./MetaTags-CPoCo-zI.js";import{_ as ee}from"./TitleBar-DIh_73dU.js";import{u as te}from"./sidebar-C-esjiO9.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const le={name:"FileUploader",emits:["setVideo","setVideoPoster"],props:{uploadLink:{type:String,required:!0},episodeId:{type:[String,Number],required:!0},episode:{required:!0},fetchFilesUrl:{type:String,required:!0}},setup(_){const i=y(null),w=y(!1),t=y([]),h=y([]),o=y(!1),l=y(-1),x=y(!1),C=L(()=>t.value.filter(n=>n.status==="pending").length),F=L(()=>t.value.filter(n=>n.status==="success").length),$=L(()=>t.value.filter(n=>n.status==="error").length),B=async()=>{try{const n=await V.post(_.fetchFilesUrl,{episode_id:_.episodeId});n.ok&&Array.isArray(n.files)?h.value=n.files.map(u=>({name:u.name,id:u.name})):h.value=[]}catch(n){console.error("Failed to fetch existing files:",n),h.value=[]}};B();const M=()=>{i.value.click()},c=n=>{n.preventDefault(),w.value=!0},s=n=>{n.preventDefault(),w.value=!1;const u=Array.from(n.dataTransfer.files);r(u)},D=n=>{const u=Array.from(n.target.files);r(u),n.target.value=""},r=n=>{const u=n.map(p=>({id:Date.now()+Math.random(),name:p.name,size:p.size,file:p,progress:0,status:"pending",error:null}));t.value.push(...u)},O=async()=>{if(o.value)return;o.value=!0,x.value=!1,l.value=-1;const n=t.value.filter(u=>u.status==="pending");for(let u=0;u<n.length&&!x.value;u++){l.value=t.value.findIndex(p=>p.id===n[u].id);try{await H(n[u])}catch(p){console.error("Upload stopped due to error:",p);break}await new Promise(p=>setTimeout(p,100))}o.value=!1,l.value=-1,x.value||await B()},R=()=>{x.value=!0,o.value=!1},H=n=>new Promise((u,p)=>{const f=t.value.findIndex(b=>b.id===n.id);if(f===-1){p(new Error("File not found"));return}t.value[f]={...t.value[f],status:"uploading",progress:0},V.uploadFile(_.uploadLink,n.file,{episode_id:_.episodeId},b=>{f!==-1&&(t.value[f]={...t.value[f],progress:parseInt(b)})},b=>{if(console.log("resp",b),b.ok&&b.status)t.value[f]={...t.value[f],status:"success",progress:100},u(b);else{const I=b.error||"Upload failed";t.value[f]={...t.value[f],status:"error",error:I},p(new Error(I))}},b=>{t.value[f]={...t.value[f],status:"error",error:"Network error occurred"},p(new Error("Network error occurred"))})});return{fileInput:i,isDragging:w,files:t,isUploading:o,currentUploadIndex:l,pendingFilesCount:C,successCount:F,errorCount:$,triggerFileInput:M,handleDragOver:c,handleDrop:s,handleFileSelect:D,formatBytes:(n,u=2)=>{if(n===0)return"0 Bytes";const p=1024,f=u<0?0:u,b=["Bytes","KB","MB","GB"],I=Math.floor(Math.log(n)/Math.log(p));return parseFloat((n/Math.pow(p,I)).toFixed(f))+" "+b[I]},existingFiles:h,fileTypeIs:(n,u)=>{const p=n.toLowerCase().split(".").pop();return u.indexOf(p)>-1},importantFormats:n=>{const u=["mp4","png","jpg","mpd"],p=n.toLowerCase().split(".").pop();return u.indexOf(p)>-1},startSequentialUpload:O,stopUpload:R,clearCompleted:()=>{t.value=t.value.filter(n=>n.status==="pending")},clearAll:()=>{t.value=[]}}}},oe={class:"w-full max-w-2xl mx-auto"},ie={class:"flex flex-col items-center justify-center space-y-3"},ne={class:"text-sm text-gray-500 mt-1"},re={key:0,class:"text-sm text-blue-500 mt-1"},ae={key:0,class:"mt-6 space-y-3",dir:"ltr"},de={class:"flex items-center justify-between"},ue={class:"flex items-center space-x-3 flex-1"},pe={class:"flex-1"},ve={class:"font-medium text-gray-800 truncate max-w-xs"},me={class:"text-sm text-gray-500 flex gap-4"},ce={key:0},ge={class:"flex-1"},fe=["value"],be={class:"flex items-center space-x-2"},xe={key:0,class:"w-8 h-8"},ye={key:1,class:"w-8 h-8"},_e={key:2,class:"w-8 h-8"},we={key:0,class:"mt-2 text-red-500 text-sm"},ke={key:1,class:"mt-4 flex gap-2"},he={key:2,class:"mt-4 p-4 bg-blue-50 rounded-lg"},Ce={class:"flex items-center justify-between"},Fe={class:"text-sm text-blue-600"},Ue={key:3,class:"mt-8",dir:"ltr"},Ve={class:"space-y-2"},De={class:"flex items-center space-x-3"},Ie={class:"font-medium text-gray-700 truncate"},Se={key:0},Be=["onClick"],Me={key:1},Te=["onClick"],Ae={class:"grid grid-cols-1 md:grid-cols-3 gap-3 mt-4"},ze={class:"flex items-center space-x-3"},Le={class:"font-medium text-sm text-gray-700 truncate"};function $e(_,i,w,t,h,o){return a(),d("div",oe,[e("div",{class:m(["relative border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-all duration-300",{"border-blue-500 bg-blue-50":t.isDragging,"border-gray-300 hover:border-gray-400 hover:bg-gray-50":!t.isDragging}]),onDragover:i[1]||(i[1]=T((...l)=>t.handleDragOver&&t.handleDragOver(...l),["prevent"])),onDragenter:i[2]||(i[2]=T(l=>t.isDragging=!0,["prevent"])),onDragleave:i[3]||(i[3]=T(l=>t.isDragging=!1,["prevent"])),onDrop:i[4]||(i[4]=T((...l)=>t.handleDrop&&t.handleDrop(...l),["prevent"])),onClick:i[5]||(i[5]=(...l)=>t.triggerFileInput&&t.triggerFileInput(...l))},[e("input",{ref:"fileInput",type:"file",multiple:"",class:"hidden",onChange:i[0]||(i[0]=(...l)=>t.handleFileSelect&&t.handleFileSelect(...l))},null,544),e("div",ie,[i[11]||(i[11]=e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1.5",d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})],-1)),e("div",null,[i[10]||(i[10]=e("p",{class:"font-medium text-gray-700"},[e("span",{class:"text-blue-600 font-semibold"},"Click to upload"),S(" or drag and drop ")],-1)),e("p",ne," Supports multiple files ("+g(t.files.length)+" selected) ",1),t.isUploading?(a(),d("p",re," Uploading... "+g(t.currentUploadIndex+1)+"/"+g(t.files.length),1)):v("",!0)])])],34),t.files.length>0?(a(),d("div",ae,[(a(!0),d(P,null,j(t.files,(l,x)=>(a(),d("div",{key:l.id,class:m(["border rounded-lg p-4 bg-white shadow-sm",{"border-blue-200 bg-blue-50":l.status==="uploading","border-green-200 bg-green-50":l.status==="success","border-red-200 bg-red-50":l.status==="error"}])},[e("div",de,[e("div",ue,[i[12]||(i[12]=e("div",{class:"bg-gray-100 p-2 rounded-lg"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})])],-1)),e("div",pe,[e("p",ve,g(l.name),1),e("div",me,[e("div",null,[e("span",null,g(t.formatBytes(l.size)),1)]),l.progress>0?(a(),d("div",ce,[e("span",null,g(l.progress)+"%",1)])):v("",!0),e("div",ge,[e("progress",{class:"progress progress-primary w-full",value:l.progress,max:"100"},null,8,fe)])])])]),e("div",be,[l.status==="uploading"?(a(),d("div",xe,i[13]||(i[13]=[e("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"},null,-1)]))):l.status==="error"?(a(),d("div",ye,i[14]||(i[14]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-red-500",viewBox:"0 0 20 20",fill:"currentColor"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1)]))):l.status==="success"?(a(),d("div",_e,i[15]||(i[15]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-green-500",viewBox:"0 0 20 20",fill:"currentColor"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)]))):v("",!0)])]),l.status==="error"?(a(),d("div",we,g(l.error),1)):v("",!0)],2))),128))])):v("",!0),t.files.length>0&&!t.isUploading?(a(),d("div",ke,[e("button",{onClick:i[6]||(i[6]=(...l)=>t.startSequentialUpload&&t.startSequentialUpload(...l)),class:"btn btn-primary"}," Start Upload ("+g(t.pendingFilesCount)+" files) ",1),e("button",{onClick:i[7]||(i[7]=(...l)=>t.clearCompleted&&t.clearCompleted(...l)),class:"btn btn-outline"}," Clear Completed "),e("button",{onClick:i[8]||(i[8]=(...l)=>t.clearAll&&t.clearAll(...l)),class:"btn btn-outline"}," Clear All ")])):v("",!0),t.isUploading?(a(),d("div",he,[e("div",Ce,[e("div",null,[i[16]||(i[16]=e("p",{class:"font-medium text-blue-700"},"Uploading in progress...",-1)),e("p",Fe,g(t.currentUploadIndex+1)+" of "+g(t.files.length)+" files ("+g(t.successCount)+" successful, "+g(t.errorCount)+" failed) ",1)]),e("button",{onClick:i[9]||(i[9]=(...l)=>t.stopUpload&&t.stopUpload(...l)),class:"btn btn-sm btn-outline text-red-600"}," Stop Upload ")])])):v("",!0),t.existingFiles.length>0?(a(),d("div",Ue,[i[18]||(i[18]=e("h3",{class:"text-lg font-medium text-gray-200 mb-3"},"Uploaded Files",-1)),e("div",Ve,[(a(!0),d(P,null,j(t.existingFiles.filter(l=>t.importantFormats(l.name)===!0),(l,x)=>(a(),d("div",{key:l.id||l.name,class:"p-3 bg-gray-50 rounded-lg border flex flex-col gap-4"},[e("div",De,[i[17]||(i[17]=e("div",{class:"bg-gray-200 p-2 rounded"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-gray-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})])],-1)),e("span",Ie,g(l.name),1)]),t.fileTypeIs(l.name,["mpd","mp4"])?(a(),d("div",Se,[e("button",{onClick:C=>_.$emit("setVideo",l),class:m([{"btn-primary":l.name==w.episode.video_target},"btn btn-sm"])},"Set Video",10,Be)])):v("",!0),t.fileTypeIs(l.name,["png","jpg"])?(a(),d("div",Me,[e("button",{onClick:C=>_.$emit("setVideoPoster",l),class:m([{"btn-primary":l.name==w.episode.video_poster},"btn btn-sm"])},"Set Video Poster",10,Te)])):v("",!0)]))),128)),e("div",Ae,[(a(!0),d(P,null,j(t.existingFiles.filter(l=>t.importantFormats(l.name)===!1),(l,x)=>(a(),d("div",{key:l.id||l.name,class:"p-3 bg-gray-50 rounded-lg border opacity-50"},[e("div",ze,[e("span",Le,g(l.name),1)])]))),128))])])])):v("",!0)])}const Pe=se(le,[["render",$e]]),je={class:"mr-auto flex gap-4 items-center"},Ee={role:"tablist",class:"tabs tabs-box"},qe=["src"],Ne={key:0,class:"flex gap-4 lg:items-start flex-col lg:flex-row w-full mt-4 py-4"},Oe={class:"w-full flex flex-col gap-4 rounded-lg bg-base-200 p-2 lg:p-4"},Re={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},He={class:"fieldset"},Ge={class:"border border-primary p-4 rounded-xl bg-base-100"},Ke={class:"flex gap-4 justify-start mt-4"},Qe={key:0,class:"mt-6"},Je={class:"fieldset"},We={class:"border border-primary p-4 rounded-xl bg-base-100"},Xe={class:"flex gap-4 justify-start mt-4"},Ye={key:0,class:"p-2 rounded-xl mt-4 bg-green-500/10 text-green-700",dir:"auto"},Ze={class:"fieldset"},et={class:"grid grid-cols-1 md:grid-cols-3"},tt={class:"fieldset bg-base-100 border-base-300 rounded-box w-64 border p-4 lg:mt-auto w-full"},st={class:"label"},lt=["checked"],ot={class:"text-center"},it={key:1,class:"flex gap-4 lg:items-start flex-col lg:flex-row w-full mt-4 py-4"},nt={key:2,class:"flex gap-4 lg:items-start flex-col lg:flex-row w-full mt-4 py-4"},bt={__name:"ProductEpisodeManageView",setup(_){const i=te(),w=G(),t=K(),h=W(),o=y({}),l=y({title:""}),x=async()=>{const c=await V.post("admin/product/info",{id:t.params.product_id});c.ok&&(l.value=c.product,t.name!="admin_product_episode_new"&&C())},C=async()=>{const c=await V.post("admin/product/episode-info",{episode_id:t.params.episode_id});c.ok&&(o.value=c.episode)},F=async()=>{const c=await V.post("admin/product/episode-save",{...o.value,product_id:t.params.product_id});c.ok&&(w.showToast("عملیات با موفقیت انجام شد!","success"),t.name=="admin_product_episode_new"&&(await h.push({name:"admin_product_episode_edit",params:{product_id:t.params.product_id,episode_id:c.episode_id}}),C()))};t.name=="admin_product_episode_new"?i.setTitle("ایجاد قسمت جدید"):i.setTitle("ویرایش قسمت");const $=c=>{o.value.video_target=c.name,F()},B=c=>{o.value.video_poster=c.name,F()};Q(()=>{x()});const M=L(()=>`\`\`\` 
<h1>${o.value.title}</h1> <br> ${o.value.description} 
 \`\`\` 
---
  
`);return(c,s)=>{const D=X("RouterLink");return a(),d("div",null,[U(ee,{title:k(i).getTitle+" - ("+l.value.title+")"},{default:A(()=>[e("div",je,[e("div",Ee,[U(D,{to:{hash:""},role:"tab",class:m(["tab",{"tab-active tab-primary":k(t).hash==""}])},{default:A(()=>s[19]||(s[19]=[S(" اطلاعات کلی ")])),_:1,__:[19]},8,["class"]),U(D,{to:{hash:"#meta"},class:m([{"tab-active":k(t).hash=="#meta"},"tab"]),role:"tab"},{default:A(()=>s[20]||(s[20]=[S(" متا تگ‌ها ")])),_:1,__:[20]},8,["class"]),U(D,{to:{hash:"#videos"},class:m([{"tab-active":k(t).hash=="#videos"},"tab"]),role:"tab"},{default:A(()=>s[21]||(s[21]=[S(" ویدیو ")])),_:1,__:[21]},8,["class"])]),e("img",{src:k(V).server+l.value.image,class:"size-10 rounded-xl",alt:""},null,8,qe)])]),_:1},8,["title"]),k(t).hash==""?(a(),d("div",Ne,[e("div",Oe,[e("div",Re,[e("fieldset",He,[s[22]||(s[22]=e("legend",{class:"fieldset-legend"},"عنوان قسمت دوره",-1)),z(e("input",{"onUpdate:modelValue":s[0]||(s[0]=r=>o.value.title=r),class:"input input-primary w-full",type:"text",placeholder:"عنوان محصول"},null,512),[[E,o.value.title]])]),U(N,{title:"لینک قسمت","site-domain":"/","ai-use-type":"link_generator","ai-input":o.value.title,modelValue:o.value.link,"onUpdate:modelValue":s[1]||(s[1]=r=>o.value.link=r)},null,8,["ai-input","modelValue"])]),e("div",{class:m({"opacity-70":o.value.display_status==="introduction"})},[U(N,{maxlength:140,title:"توضیح کوتاه","ai-use-type":"small_description","ai-input":M.value,modelValue:o.value.small_description,"onUpdate:modelValue":s[2]||(s[2]=r=>o.value.small_description=r)},null,8,["ai-input","modelValue"])],2),e("div",{class:m({"opacity-70":o.value.display_status==="introduction"})},[s[23]||(s[23]=e("legend",{class:"fieldset-legend"},"توضیحات",-1)),(a(),q(Y,{key:o.value.id,value:o.value.description,onInput:s[3]||(s[3]=r=>o.value.description=r)},null,8,["value"]))],2),e("div",Ge,[s[25]||(s[25]=e("div",null," نوع ارائه این قسمت : ",-1)),e("div",Ke,[e("button",{class:m([`${o.value.display_status==="introduction"?"":"btn-outline"}`,"btn btn-primary"]),onClick:s[4]||(s[4]=r=>o.value.display_status="introduction")}," معرفی دوره ",2),e("button",{class:m([`${o.value.display_status==="free"?"":"btn-outline"}`,"btn btn-primary"]),onClick:s[5]||(s[5]=r=>o.value.display_status="free")},"رایگان",2),e("button",{class:m([`${o.value.display_status==="free_with_login"?"":"btn-outline"}`,"btn btn-primary"]),onClick:s[6]||(s[6]=r=>o.value.display_status="free_with_login")}," رایگان با لاگین ",2),e("button",{class:m([`${o.value.display_status==="vip_preview"?"":"btn-outline"}`,"btn btn-primary"]),onClick:s[7]||(s[7]=r=>o.value.display_status="vip_preview")}," خرید+پیش‌نمایش ",2),e("button",{class:m([`${o.value.display_status==="vip"?"":"btn-outline"}`,"btn btn-primary"]),onClick:s[8]||(s[8]=r=>o.value.display_status="vip")}," خرید ",2)]),o.value.display_status=="vip_preview"?(a(),d("div",Qe,[e("fieldset",Je,[s[24]||(s[24]=e("legend",{class:"fieldset-legend"},"مدت زمان پیش نمایش رایگان (به ثانیه)",-1)),z(e("input",{"onUpdate:modelValue":s[9]||(s[9]=r=>o.value.free_demo_time=r),class:"input input-primary w-full",type:"number",placeholder:""},null,512),[[E,o.value.free_demo_time]])])])):v("",!0)]),e("div",We,[s[26]||(s[26]=e("div",null," نوع ویدیو : ",-1)),e("div",Xe,[e("button",{class:m([`${o.value.video_type==="dash"?"":"btn-outline"}`,"btn btn-primary"]),onClick:s[10]||(s[10]=r=>o.value.video_type="dash")},"DASH",2),e("button",{class:m([`${o.value.video_type==="mp4"?"":"btn-outline"}`,"btn btn-primary"]),onClick:s[11]||(s[11]=r=>o.value.video_type="mp4")},"mp4",2)]),o.value.video_target?(a(),d("div",Ye,g(o.value.video_target),1)):v("",!0)]),e("div",null,[e("fieldset",Ze,[s[27]||(s[27]=e("legend",{class:"fieldset-legend"},"جاییگاه (برای مرتب سازی) (به صورت عدد 0 تا 100)",-1)),z(e("input",{"onUpdate:modelValue":s[12]||(s[12]=r=>o.value.sort_index=r),class:"input input-primary w-full",type:"text",placeholder:""},null,512),[[E,o.value.sort_index]])])]),e("div",et,[e("fieldset",tt,[e("label",st,[z(e("input",{type:"checkbox","onUpdate:modelValue":s[13]||(s[13]=r=>o.value.publish=r),checked:o.value.publish,class:"checkbox checkbox-success"},null,8,lt),[[J,o.value.publish]]),s[28]||(s[28]=S(" انتشار "))])])]),e("div",ot,[e("button",{onClick:s[14]||(s[14]=r=>F()),class:"btn btn-success"}," ذخیره قسمت ")])])])):v("",!0),k(t).hash=="#meta"?(a(),d("div",it,[o.value.id?(a(),q(Z,{key:0,modelValue:o.value,"onUpdate:modelValue":s[15]||(s[15]=r=>o.value=r),"ai-input":M.value,onSave:s[16]||(s[16]=r=>F())},null,8,["modelValue","ai-input"])):v("",!0)])):v("",!0),k(t).hash=="#videos"?(a(),d("div",nt,[o.value.id?(a(),q(Pe,{key:0,onSetVideoPoster:s[17]||(s[17]=r=>B(r)),onSetVideo:s[18]||(s[18]=r=>$(r)),"fetch-files-url":"get-episode-files",episode:o.value,"episode-id":o.value.id,"upload-link":"admin/product/upload-episode-video"},null,8,["episode","episode-id"])):v("",!0)])):v("",!0)])}}};export{bt as default};
